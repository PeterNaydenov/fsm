"use strict";var t=require("ask-for-promise"),e=require("dt-toolbox"),n=require("@peter.naydenov/dt-queries");const a={_setTransitions:function(){return function(t,e){let n={},a={},i={};return t.forEach((t=>{const[s,o,r,c,u]=t,d=e[c],p=`${s}/${o}`;n[p]=d||null,a[p]=r,function(t){return t instanceof Array&&(2==t.length&&(t.forEach((t=>{if(!1!==t||"string"!=typeof t)return!1})),!0))}(u)&&(i[p]=[],i[p][0]=u[0],i[p][1]=u[1])})),{transitions:n,nextState:a,chainActions:i}}},_updateStateData:function(t){return function(e){const{dtbox:n,query:a}=t.dependencies;let i="javascriptObject";return e.export&&(i="dt-object"),e instanceof Array&&e[0][0]===e[0][2]&&e.every((t=>4===t.length))&&(i="dt-model"),"javascriptObject"===i&&e instanceof Array?(console.error("State update failed. Reason: Received an array. Expectation: Object where top-level property name is the name of the data segment."),t.stateData):(["javascriptObject"].includes(i)&&(e=n.init(e).export()),["javascriptObject","dt-model"].includes(i)&&(e=n.load(e)),["javascriptObject","dt-model","dt-object"].includes(i)&&(e=e.query(a.splitSegments)),t.stateData.query(a.updateState,e))}},_updateStep:function(t){return function(e,n,a){const{askForPromise:i}=t.dependencies,s=i(),o=`${t.state}/${n}`,r=t.callback;t.lock=!0,t._transit(s,o,a),s.onComplete((n=>{let a=t._getChain(o),i=n.response;if(n.success){if(t.state=t.nextState[o],null!=n.stateData&&(t.stateData=t._updateStateData(n.stateData)),r.positive.forEach((e=>e(t.state,i))),r.transition.forEach((e=>e(t.state,i))),a&&a[0])return void t._updateStep(e,a[0],i)}else if(r.negative.forEach((e=>e(t.state,i))),r.transition.forEach((e=>e(t.state,i))),a&&a[1])return void t._updateStep(e,a[1],i);e.done(i)})),s.promise.catch((()=>console.log(`Failed in step ${o}`)))}},_warn:function(t){return function(t){Object.entries(t).forEach((([t,e])=>{null==e&&console.log(`Warning: Transition for ${t} is not defined`)}))}},_transit:function(t){return function(){const[e,n,...a]=arguments,{state:i,stateData:s,dependencies:o}=t,r=t.transitions[n],c=t.api.extractList;"function"==typeof r?r({task:e,state:i,extractList:c,dependencies:o},...a):e.done({success:!1})}},_getChain:function(t){return function(e){const n=t.chainActions;return!!n[e]&&n[e]}},_triggerCacheUpdate:function(t){return function(){if(0!==t.cache.length){const{updateTask:e,action:n,dt:a}=t.cache[0];t.cache=t.cache.reduce(((t,e,n)=>(0!=n&&t.push(e),t)),[]),t._updateStep(e,n,a),e.onComplete((e=>t._onUpdateTask(e)))}}},_onUpdateTask:function(t){return function(e){const n=t.callback,a=t.dependencies.askForPromise(n.update);n.update.forEach(((n,i)=>{n(t.state,e),a[i].done()})),a.onComplete((e=>{t.lock=!1,t._triggerCacheUpdate()}))}},setDependencies:function(t){return function(e){t.dependencies={...t.dependencies,...e}}},getDependencies:function(t){return function(){return t.dependencies}},on:function(t){return function(e,n){const a=t.callback;a[e]&&a[e].push(n)}},off:function(t){return function(e){t.callback[e]&&(t.callback[e]=[])}},importState:function(t){return function({state:e,stateData:n}){const{dtbox:a,query:i}=t.dependencies;if(e&&(t.state=e,n)){const e=a.load(n).query(i.splitSegments);t.stateData=t.stateData.query(i.updateState,e)}}},exportState:function(t){return function(){const{query:e}=t.dependencies;return{state:t.state,stateData:t.stateData.query(e.joinSegments).export()}}},update:function(t){return function(e,n){const{askForPromise:a}=t.dependencies,i=a();return t.lock?(t.cache.push({updateTask:i,action:e,dt:n}),i.promise):(t._updateStep(i,e,n),i.onComplete((e=>t._onUpdateTask(e))),i.promise)}},reset:function(t){return function(){const{dtbox:e}=t.dependencies;t.state=t.initialState,t.stateData=e.load(t.initialStateData.export())}},ignoreCachedUpdates:function(t){return function(){t.cache.forEach((({updateTask:t,action:e,dt:n})=>t.cancel(`Action '${e}' was ignored`))),t.cache=[]}},getState:function(t){return function(){return t.state}},extractList:function(t){return function(e,n=!1){const a=t.dependencies.query;return 0==arguments.length?t.stateData.query(a.joinSegments).model((()=>({as:"std"}))):n?t.stateData.extractList(e,n):t.stateData.extractList(e,t.stateDataFormat)}}},i=e.getWalk();function s({init:s,behavior:o,stateData:r={},debug:c,stateDataFormat:u={as:"std"}},d={}){const p=this,l={};p.state=s||"N/A",p.initialState=s||"N/A",p.stateDataFormat=u,p.lock=!1,p.cache=[],p.dependencies={walk:i,dtbox:e,askForPromise:t,query:{splitSegments:n.splitSegments,joinSegments:n.joinSegments,updateState:n.updateState}},p.callback={update:[],transition:[],positive:[],negative:[]};for(let t in a)t.startsWith("_")?p[t]=a[t](p):l[t]=a[t](p);p.api=l,p.stateData=e.init(r).query(n.splitSegments),p.initialStateData=e.init(r).query(n.splitSegments);const{transitions:f,nextState:h,chainActions:S}=p._setTransitions(o,d);return c&&(p._warn(f),global.debugFSM=p),p.transitions=f,p.nextState=h,p.chainActions=S,l}s.dependencies={walk:i,dtbox:e,askForPromise:t,query:{splitSegments:n.splitSegments,joinSegments:n.joinSegments,updateState:n.updateState}},module.exports=s;
